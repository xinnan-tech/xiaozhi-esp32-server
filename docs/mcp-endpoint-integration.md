# MCPエンドポイント利用ガイド

このチュートリアルでは、オープンソースのMCP計算機機能を例に、カスタムMCPサービスを自身のエンドポイントに統合する方法を説明します。

前提条件として、`xiaozhi-server`でMCPエンドポイント機能が有効になっている必要があります。有効化していない場合は、先に[このチュートリアル](./mcp-endpoint-enable.md)を参照して有効化してください。

# インテリジェントエージェントにMCP機能（計算機機能など）を追加する方法

### 全モジュールデプロイの場合
全モジュールデプロイ環境では、智控台にログインし、エージェント管理から`角色設定`を選択、`意图识别`の右側にある`機能編集`ボタンをクリックします。

表示されたページの下部に`MCPエンドポイント`セクションがあり、通常はそのエージェントの`MCPエンドポイントアドレス`が表示されます。ここではMCP技術を利用した計算機機能を追加します。

この`MCPエンドポイントアドレス`は後で使用するので重要です。

### 単一モジュールデプロイの場合
単一モジュールデプロイで既に設定ファイルにMCPエンドポイントアドレスを設定している場合、起動時に以下のようなログが出力されます。
```
250705[__main__]-INFO-初期化コンポーネント: vad成功 SileroVAD
250705[__main__]-INFO-初期化コンポーネント: asr成功 FunASRServer
250705[__main__]-INFO-OTAインターフェース:          http://192.168.1.25:8002/xiaozhi/ota/
250705[__main__]-INFO-視覚分析インターフェース:     http://192.168.1.25:8002/mcp/vision/explain
250705[__main__]-INFO-MCPエンドポイント:        ws://192.168.1.25:8004/mcp_endpoint/mcp/?token=abc
250705[__main__]-INFO-Websocketアドレス:    ws://192.168.1.25:8000/xiaozhi/v1/
250705[__main__]-INFO-=======上記のアドレスはwebsocketプロトコルアドレスです、ブラウザで直接アクセスしないでください=======
250705[__main__]-INFO-Websocketをテストする場合はGoogle Chromeでtestディレクトリのtest_page.htmlを開いてください
250705[__main__]-INFO-=============================================================
```

上記のように、`MCPエンドポイント: ws://192.168.1.25:8004/mcp_endpoint/mcp/?token=abc`と出力されていれば、これがあなたの`MCPエンドポイントアドレス`です。

この`MCPエンドポイントアドレス`は後で使用するので重要です。

## ステップ1: MCP計算機プロジェクトのコードをダウンロード

ブラウザで[計算機プロジェクト](https://github.com/78/mcp-calculator)を開きます。

ページ内の緑色の`Code`ボタンをクリックし、`Download ZIP`を選択してプロジェクトのソースコードをダウンロードします。

ダウンロード後、解凍します。解凍後のフォルダ名が`mcp-calculatorr-main`の場合、`mcp-calculator`にリネームしてください。その後、コマンドラインでプロジェクトディレクトリに移動し、依存関係をインストールします。

```bash
# プロジェクトディレクトリに移動
cd mcp-calculator

conda remove -n mcp-calculator --all -y
conda create -n mcp-calculator python=3.10 -y
conda activate mcp-calculator

pip install -r requirements.txt
```

## ステップ2: 起動

起動前に、智控台のエージェントからMCPエンドポイントアドレスをコピーします。

例:
```
ws://192.168.1.25:8004/mcp_endpoint/mcp/?token=abc
```

以下のコマンドを実行します。

```bash
export MCP_ENDPOINT=ws://192.168.1.25:8004/mcp_endpoint/mcp/?token=abc
```

その後、プログラムを起動します。

```bash
python mcp_pipe.py calculator.py
```

### 智控台デプロイの場合
智控台デプロイ環境では、起動後に智控台でMCPの接続状態をリフレッシュすると、追加した機能リストが表示されます。

### 単一モジュールデプロイの場合
単一モジュールデプロイ環境では、デバイスが接続されると以下のようなログが出力され、成功したことが確認できます。

```
250705 -INFO-MCPエンドポイント初期化中: wss://2662r3426b.vicp.fun/mcp_e 
250705 -INFO-MCPエンドポイント初期化メッセージ送信
250705 -INFO-MCPエンドポイント接続成功
250705 -INFO-MCPエンドポイント初期化成功
250705 -INFO-統一ツールハンドラ初期化完了
250705 -INFO-MCPエンドポイントサーバー情報: name=Calculator, version=1.9.4
250705 -INFO-MCPエンドポイントでサポートされるツール数: 1
250705 -INFO-全てのMCPエンドポイントツールを取得、クライアント準備完了
250705 -INFO-ツールキャッシュ更新済み
250705 -INFO-現在サポートされている関数リスト: [ 'get_time', 'get_lunar', 'play_music', 'get_weather', 'handle_exit_intent', 'calculator']
```

`'calculator'`が含まれていれば、デバイスは意図認識に基づいて計算機ツールを呼び出すことができます。