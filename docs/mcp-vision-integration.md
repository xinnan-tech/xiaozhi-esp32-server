# ビジュアルモデル利用ガイド
このチュートリアルは2つのパートで構成されています：
- パート1: 単一モジュールでxiaozhi-serverを実行しビジュアルモデルを有効化
- パート2: 全モジュール実行時におけるビジュアルモデルの有効化方法

ビジュアルモデルを有効化する前に、以下の3つの準備が必要です：
- カメラ搭載デバイスを準備し、そのデバイスがリポジトリでカメラ機能を実装済みであること（例：`立創・実戦派ESP32-S3開発ボード`）
- デバイスのファームウェアバージョンが1.6.6以上であること
- 基本的な対話モジュールが正常に動作していること

## 単一モジュールでxiaozhi-serverを実行しビジュアルモデルを有効化

### ステップ1: ネットワーク確認
ビジュアルモデルはデフォルトで8003ポートを使用します。

Dockerで実行している場合、`docker-compose.yml`に`8003`ポートが開放されているか確認してください。開放されていない場合は最新の`docker-compose.yml`ファイルに更新してください。

ソースコードから実行している場合、ファイアウォールで`8003`ポートが許可されているか確認してください。

### ステップ2: ビジュアルモデルの選択
`data/.config.yaml`ファイルを開き、`selected_module.VLLM`に使用するビジュアルモデルを設定します。現在、`openai`タイプのインターフェースに対応したビジュアルモデルをサポートしています。`ChatGLMVLLM`はそのうちの1つで、`openai`と互換性があります。

```
selected_module:
  VAD: ..
  ASR: ..
  LLM: ..
  VLLM: ChatGLMVLLM
  TTS: ..
  Memory: ..
  Intent: ..
```

`ChatGLMVLLM`をビジュアルモデルとして使用する場合、まず[智譜AI](https://bigmodel.cn/usercenter/proj-mgmt/apikeys)のウェブサイトにログインし、APIキーを申請する必要があります。既にキーを取得している場合は、それを再利用できます。

設定ファイルに以下の設定を追加します。既にある場合は、api_keyを正しく設定してください。

```
VLLM:
  ChatGLMVLLM:
    api_key: あなたのapi_key
```

### ステップ3: xiaozhi-serverサービスの起動
ソースコードから実行する場合は、以下のコマンドを実行します。
```
python app.py
```
Dockerで実行している場合は、コンテナを再起動します。
```
docker restart xiaozhi-esp32-server
```

起動後、以下のようなログが出力されます。

```
2025-06-01 **** - OTAインターフェース:           http://192.168.4.7:8003/xiaozhi/ota/
2025-06-01 **** - ビジュアル分析インターフェース:        http://192.168.4.7:8003/mcp/vision/explain
2025-06-01 **** - Websocketアドレス:       ws://192.168.4.7:8000/xiaozhi/v1/
2025-06-01 **** - =======上記のアドレスはwebsocketプロトコルアドレスです、ブラウザで直接アクセスしないでください=======
2025-06-01 **** - Websocketをテストする場合はGoogle Chromeでtestディレクトリのtest_page.htmlを開いてください
2025-06-01 **** - =============================================================
```

起動後、ブラウザでログに表示された`ビジュアル分析インターフェース`のURLを開いてください。Linux環境でブラウザがない場合は、以下のコマンドを実行できます。
```
curl -i あなたのビジュアル分析インターフェース
```

正常に動作している場合、以下のように表示されます。
```
MCP Vision インターフェースが正常に動作しています、ビジュアル説明インターフェースアドレスは：http://xxxx:8003/mcp/vision/explain
```

パブリックネットワークまたはDockerでデプロイしている場合、必ず`data/.config.yaml`の以下の設定を変更してください。
```
server:
  vision_explain: http://あなたのIPまたはドメイン:ポート番号/mcp/vision/explain
```

なぜなら、ビジュアル説明インターフェースはデバイスに配信される必要があり、ローカルネットワークアドレスやDocker内部アドレスの場合、デバイスからアクセスできないためです。

例えば、パブリックIPアドレスが`111.111.111.111`の場合、以下のように設定します。

```
server:
  vision_explain: http://111.111.111.111:8003/mcp/vision/explain
```

MCP Visionインターフェースが正常に動作し、ブラウザでも`ビジュアル説明インターフェースアドレス`に正常にアクセスできることを確認したら、次のステップに進んでください。

### ステップ4: デバイスのウェイクアップ

デバイスに「カメラを開いて、何が見えるか教えて」と話しかけてください。

xiaozhi-serverのログ出力を確認し、エラーがないか注意深く観察してください。


## 全モジュール実行時におけるビジュアルモデルの有効化方法

### ステップ1: ネットワーク確認
ビジュアルモデルはデフォルトで8003ポートを使用します。

Dockerで実行している場合、`docker-compose_all.yml`に`8003`ポートがマッピングされているか確認してください。マッピングされていない場合は、最新の`docker-compose_all.yml`ファイルに更新してください。

ソースコードから実行している場合、ファイアウォールで`8003`ポートが許可されているか確認してください。

### ステップ2: 設定ファイルの確認

`data/.config.yaml`ファイルを開き、その構造が`data/config_from_api.yaml`と一致しているか確認してください。異なる場合や不足している項目がある場合は、それを補完してください。

### ステップ3: ビジュアルモデルAPIキーの設定

まず[智譜AI](https://bigmodel.cn/usercenter/proj-mgmt/apikeys)のウェブサイトにログインし、APIキーを申請します。既にキーを取得している場合は、それを再利用できます。

`智控台`にログインし、上部メニューの`モデル設定`をクリック、左サイドバーの`ビジュアル言語モデル`を選択し、`VLLM_ChatGLMVLLM`を見つけて編集ボタンをクリックします。ポップアップウィンドウで`APIキー`を入力し、保存します。

保存が成功したら、テストしたいインテリジェントエージェントの`角色設定`を開き、`ビジュアル大規模言語モデル(VLLM)`で先ほど選択したビジュアルモデルが選択されているか確認します。確認後、保存します。

### ステップ3: xiaozhi-serverモジュールの起動
ソースコードから実行する場合は、以下のコマンドを実行します。
```
python app.py
```
Dockerで実行している場合は、コンテナを再起動します。
```
docker restart xiaozhi-esp32-server
```

起動後、以下のようなログが出力されます。

```
2025-06-01 **** - ビジュアル分析インターフェース:        http://192.168.4.7:8003/mcp/vision/explain
2025-06-01 **** - Websocketアドレス:       ws://192.168.4.7:8000/xiaozhi/v1/
2025-06-01 **** - =======上記のアドレスはwebsocketプロトコルアドレスです、ブラウザで直接アクセスしないでください=======
2025-06-01 **** - Websocketをテストする場合はGoogle Chromeでtestディレクトリのtest_page.htmlを開いてください
2025-06-01 **** - =============================================================
```

起動後、ブラウザでログに表示された`ビジュアル分析インターフェース`のURLを開いてください。Linux環境でブラウザがない場合は、以下のコマンドを実行できます。
```
curl -i あなたのビジュアル分析インターフェース
```

正常に動作している場合、以下のように表示されます。
```
MCP Vision インターフェースが正常に動作しています、ビジュアル説明インターフェースアドレスは：http://xxxx:8003/mcp/vision/explain
```

パブリックネットワークまたはDockerでデプロイしている場合、必ず`data/.config.yaml`の以下の設定を変更してください。
```
server:
  vision_explain: http://あなたのIPまたはドメイン:ポート番号/mcp/vision/explain
```

なぜなら、ビジュアル説明インターフェースはデバイスに配信される必要があり、ローカルネットワークアドレスやDocker内部アドレスの場合、デバイスからアクセスできないためです。

例えば、パブリックIPアドレスが`111.111.111.111`の場合、以下のように設定します。

```
server:
  vision_explain: http://111.111.111.111:8003/mcp/vision/explain
```

MCP Visionインターフェースが正常に動作し、ブラウザでも`ビジュアル説明インターフェースアドレス`に正常にアクセスできることを確認したら、次のステップに進んでください。

### ステップ4: デバイスのウェイクアップ

デバイスに「カメラを開いて、何が見えるか教えて」と話しかけてください。

xiaozhi-serverのログ出力を確認し、エラーがないか注意深く観察してください。
