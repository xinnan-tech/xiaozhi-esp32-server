<!--
Sync Impact Report:
- Version: 1.0.1 (Amendment: execution constraints + governance neutralization + deployment flexibility)
- Modified principles: N/A (kept 7 principles, clarified enforcement)
- Added sections:
  - 执行型硬约束（阶段门禁 / anti-gravity 执行规范 / MemoryBackend 接入边界）
- Modified sections:
  - 架构约束：由“微服务架构要求”调整为“部署形态与服务边界要求（模块化优先）”
  - 治理规范：宪章修订流程治理主体改为“核心维护团队/项目维护者”
- Removed sections: N/A
- Templates requiring updates:
  ✅ plan-template.md（需加入 Phase 门禁检查点）
  ✅ spec-template.md（需加入 MemoryBackend 边界与可擦除要求）
  ✅ tasks-template.md（需加入 1 task=1 PR、验收/测试/回滚字段）
- Follow-up TODOs:
  - 将“Phase 0 可运行”验收写入首批 tasks（smoke test/启动文档/健康检查）
-->

# 小智ESP32服务器 项目宪章

## 核心原则

### I. 模块化与可扩展性

系统必须采用模块化架构，支持灵活的组件替换和功能扩展：
- 每个功能模块（ASR、LLM、VLLM、TTS、Intent、Memory等）必须通过统一接口实现
- 新增AI服务提供商或功能模块不得破坏现有系统架构
- 必须支持通过配置文件切换不同服务商，无需修改核心代码
- 插件系统必须支持热加载和动态扩展

**原理**：本项目服务于多样化的硬件设备和使用场景，模块化设计确保用户可以根据成本、性能和场景需求自由组合最优方案。

### II. 协议标准化

系统必须严格遵循统一的通信协议和接口规范：
- MQTT+UDP网关、WebSocket、HTTP服务必须遵循“小智通信协议”（见项目文档/协议规范）
- MCP（Model Context Protocol）集成必须符合标准MCP协议规范
- 客户端与服务端的数据交互必须使用标准化的JSON格式
- 所有API接口变更必须向后兼容或提供明确的版本管理和迁移路径

**原理**：标准化协议确保多设备兼容性，降低集成成本，支撑开源生态的健康发展。

### III. 性能优化优先（NON-NEGOTIABLE）

系统必须持续优化响应速度和资源利用效率：
- 必须提供流式处理支持（流式ASR、流式TTS、流式LLM）以最小化首字延迟
- 必须实现并行处理机制（如声纹识别与ASR并行）
- 每次功能更新必须通过性能测试工具验证，不得引入明显性能退化
- 必须为低配置环境（2核2G）和高性能环境提供差异化配置方案

**原理**：作为实时语音交互系统，响应速度直接影响用户体验。性能优化是非妥协的核心竞争力。

### IV. 成本可控与开源友好

系统必须平衡功能丰富性与使用成本：
- 必须提供“入门全免费”配置方案，确保个人用户零成本使用
- 新增功能不得强制依赖付费服务，应优先集成开源或免费方案
- 必须明确标注每个服务提供商的收费模式和推荐使用场景
- 文档必须包含各组件的性能对比和成本分析

**原理**：降低使用门槛，扩大开源社区参与度，确保项目的可持续发展。

### V. 安全与隐私保护

系统必须保障用户数据安全和隐私：
- 不得托管用户的第三方API密钥或敏感信息，仅提供配置引导
- 声纹识别数据必须本地存储，不得上传至云端
- 必须支持SSL/TLS加密连接（WebSocket WSS、HTTPS）
- 生产环境部署必须通过安全检查，文档需明确警告潜在风险

**原理**：作为智能硬件后端服务，处理语音、图像等敏感数据，安全性是用户信任的基础。

### VI. 测试驱动开发

新功能开发必须遵循测试优先原则：
- 核心模块变更必须包含单元测试和集成测试
- 性能优化必须通过`performance_tester.py`验证
- 音频处理功能必须通过`test_page.html`工具验证
- 破坏性更改必须提供测试覆盖率报告（或可替代的质量门禁说明）

**原理**：确保代码质量和系统稳定性，降低多组件集成带来的回归风险。

### VII. 多语言与国际化支持

系统必须支持多语言和多地区使用：
- 管理后台必须支持中文简体、中文繁体、英文切换
- ASR和TTS组件必须支持多语言识别和合成
- 文档必须提供中英文版本（包括README、部署文档、API文档）
- 错误提示和日志信息需考虑国际化需求

**原理**：面向全球开源社区，多语言支持扩大用户基础和贡献者范围。

## 架构约束

### 部署形态与服务边界要求（模块化优先）

本项目以“模块化优先、部署形态可变”为原则：支持单体与多服务两种形态，是否采用微服务由 plan 阶段依据规模与需求决定。

- **Phase 0 优先单体可运行**：默认以“单服务进程/单容器”方式跑通核心链路（设备接入、对话编排、最小可用能力），避免过早引入复杂编排。
- **可演进为多服务**：当存在明确动机（性能隔离、可靠性、团队协作、独立扩缩容、成本核算）时，可拆分为多个服务（如 Gateway / AI Worker / Memory Worker / 管理后台等）。
- **模块间必须通过标准接口解耦**：服务内模块（ASR/LLM/TTS/Intent/Memory 等）必须以统一接口接入；服务间通信必须通过标准协议（MQTT、WebSocket、HTTP REST API 或等价标准）。
- **禁止紧耦合依赖**：不得跨服务直接调用内部实现细节；跨服务必须有明确的 API/Schema/版本管理策略。
- **拆分必须可回退**：任何从单体到多服务的拆分必须提供回滚路径，确保可快速退回到稳定形态。

### 部署灵活性

- 必须同时支持Docker容器化部署和本地源码部署
- 配置管理必须支持环境变量和配置文件两种方式
- 必须提供一键部署脚本和详细的手动部署文档
- OTA升级功能必须支持远程设备固件更新

### 数据存储策略

- 轻量级部署使用配置文件（YAML/JSON）存储用户数据（或等价轻量持久化方案）
- 完整部署使用数据库存储用户、设备、日志等持久化数据（数据库选型由 plan 阶段决定，需给出理由与迁移策略）
- 缓存数据使用Redis（可选）
- 声纹数据必须本地文件系统存储

## 开发流程

### 代码贡献规范

- 所有代码贡献必须通过Pull Request提交
- PR描述必须包含：功能说明、测试结果、性能影响评估
- 必须遵循项目现有代码风格（Python PEP8、Java Google Style、Vue Standard）
- 新增第三方依赖必须在文档中说明其必要性和开源协议

### 文档要求

- 新增功能必须更新相应文档（README、FAQ、部署文档）
- API变更必须更新接口文档
- 配置项变更必须同步更新配置文件示例和说明
- 重大架构变更必须提供架构图和设计文档

### 版本发布流程

- 版本号遵循语义化版本规范（MAJOR.MINOR.PATCH）
- 每个版本必须包含更新日志（CHANGELOG）
- 稳定版本必须通过完整测试套件验证
- 必须提供Docker镜像和源码包两种发布形式

## 治理规范

本宪章是项目的最高指导原则，所有代码提交、功能设计、架构决策必须符合本宪章要求。

### 宪章修订流程

- 宪章修订必须通过项目核心维护团队审批（以 GitHub 仓库的 Maintainers/Owners 权限组为准）。
- 修订提案必须在GitHub Issues中公开讨论至少7天（紧急安全修订除外）。
- 重大修订（影响核心原则或核心架构约束）需要在GitHub Discussions征求社区意见，并在合并前给出决策记录（Decision Log）。
- 修订通过后必须更新版本号并同步相关模板文件。

### 合规性审查

- 所有Pull Request必须经过至少一名核心维护者的代码审查
- 违反宪章原则的提交必须提供充分的技术正当性说明
- 引入复杂性（如新增服务依赖、架构模式变更）必须在PR中明确说明必要性
- 性能退化超过10%的变更必须提供优化方案或回退机制

### 争议解决

- 技术争议优先通过GitHub Discussions公开讨论
- 核心维护团队拥有最终决策权
- 重大决策（如放弃某项核心功能、变更技术栈）必须在社区中征集反馈

### 开发指导文件

项目使用以下文件进行运行时开发指导：
- `.specify/memory/constitution.md`（本文件）：项目治理和原则
- `docs/contributor_open_letter.md`：致开发者的公开信
- `docs/FAQ.md`：常见问题和最佳实践
- `README.md`：项目概览和快速开始

## 执行型硬约束（用于驱动 anti-gravity 自动交付）

### A. 阶段门禁（严格顺序，禁止跳关）

- **Phase 0：基础可运行（必须先完成）**
  - 本地可启动，至少一个入口（HTTP/WS/MQTT 任一）可连通
  - 提供最小 smoke test 命令（可复制执行）
  - 满足以上门禁后，才允许进入 Phase 1

- **Phase 1：接口隔离 + O-Mem 接入**
  - 引入 `MemoryBackend` 抽象；O-Mem 只能作为一个实现（如 `OmemBackend`）
  - 记忆写入默认异步；检索输出必须受 token/条数/耗时上限约束

- **Phase 2：AWS 可部署（先能部署，再谈性能）**
  - 必须 IaC（Terraform/CDK 二选一），具备 dev/staging 环境
  - 日志/指标可观测，具备回滚策略

- **Phase 3：并发与性能（≥50 设备）**
  - 提供可复现的 ≥50 设备并发模拟/压测脚本（k6 或 Python）
  - 验收包含：连接稳定性、错误率、P95、队列积压（如有）

### B. anti-gravity 执行规范（强制）

- 任务来源：`.specify/` 生成 tasks 或由其导入的 GitHub Issues
- 只有带 `ag:ready` 标签的 Issue 允许执行
- **1 Task = 1 PR**，PR 必须包含：
  - Closes #Issue
  - How to test（精确命令）
  - Acceptance criteria checklist
  - 风险评估与回滚方案
- CI 必须全绿才允许合并；行为变化必须有测试覆盖

### C. 记忆系统接入边界（强制）

必须存在统一接口（名称可变但职责不变）：
- `retrieve_context(user_id, device_id, query, token_budget)`
- `ingest_turn(user_id, device_id, messages, meta)`
- `end_session(user_id, device_id, session_meta)`
- `forget_user(user_id, scope)`

约束：
- 网关层不得直接写长期记忆；写入默认走队列/worker 异步
- 检索返回必须受 token_budget 约束，禁止无限拼接 prompt

## 参考链接（如需）
```text
小智通信协议（Feishu）:
https://ccnphfhqs21z.feishu.cn/wiki/M0XiwldO9iJwHikpXD5cEx71nKh
